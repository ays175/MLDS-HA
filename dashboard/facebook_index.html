<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Facebook Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // Improve chart legibility on dark background
      if (window.Chart) {
        Chart.defaults.color = '#ffffff';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';
        Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.05)';
        if (Chart.defaults.plugins && Chart.defaults.plugins.legend && Chart.defaults.plugins.legend.labels) {
          Chart.defaults.plugins.legend.labels.color = '#ffffff';
          Chart.defaults.plugins.legend.labels.font = { size: 12, weight: '500' };
        }
        if (Chart.defaults.plugins && Chart.defaults.plugins.tooltip) {
          Chart.defaults.plugins.tooltip.titleColor = '#ffffff';
          Chart.defaults.plugins.tooltip.bodyColor = '#ffffff';
          Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.85)';
          Chart.defaults.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.2)';
          Chart.defaults.plugins.tooltip.borderWidth = 1;
        }
        if (Chart.defaults.scale && Chart.defaults.scale.ticks) {
          Chart.defaults.scale.ticks.color = '#ffffff';
        }
      }
    </script>
    <script>
      tailwind.config = { theme: { extend: { colors: { primary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' }, success: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' }, warning: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f' }, danger: { 50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d' }, neutral: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' } } } } }
    </script>
    <style>
      body { background: linear-gradient(135deg, #2563eb 0%, #1e293b 100%); min-height: 100vh; font-family: 'Poppins', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
      .card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.12); transition: all 0.2s ease; }
      .card:hover { background: rgba(255, 255, 255, 0.12); border-color: rgba(255, 255, 255, 0.2); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
      .header-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
      .section-card { background: rgba(255, 255, 255, 0.06); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
      .chart-container { height: 320px; position: relative; }
      .chart-container-small { height: 240px; }
      .metric-primary { font-size: 2.25rem; font-weight: 700; line-height: 1.1; letter-spacing: -0.025em; }
      .section-title { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.025em; position: relative; padding-bottom: 12px; }
      .section-title::after { content: ''; position: absolute; bottom: 0; left: 0; width: 48px; height: 3px; background: linear-gradient(90deg, #0ea5e9, #22c55e); border-radius: 2px; }
      .loading-spinner { width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.2); border-top: 2px solid #ffffff; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      /* Tooltip styles (match TikTok) */
      .tooltip { position: fixed; background: rgba(0, 0, 0, 0.9); color: #fff; padding: 12px 16px; border-radius: 8px; font-size: 0.875rem; line-height: 1.4; max-width: 280px; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 0.2s ease; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
      .tooltip.show { opacity: 1; }
      .chart-help { margin-top: 4px; }
    </style>
  </head>
  <body>
    <div class="sticky top-0 z-50 header-card">
      <div class="max-w-7xl mx-auto px-6 py-5">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-white">Facebook Analytics</h1>
            <p class="text-white/60 text-sm font-medium">Performance Intelligence Dashboard</p>
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
              <input id="datasetId" class="rounded-lg px-4 py-2 text-sm w-48" placeholder="Dataset ID (optional)" />
              <button id="loadBtn" class="btn-primary px-6 py-2 rounded-lg text-sm flex items-center gap-2">
                <span id="loadText">Load Data</span>
                <div id="loadSpinner" class="loading-spinner hidden"></div>
              </button>
            </div>
            <div id="status" class="text-white/60 text-sm flex items-center gap-2"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto p-6 space-y-8">
      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Executive Summary</h2>
        <div id="executiveSummary" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Key Performance Indicators</h2>
        <div id="kpis" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Performance Overview</h2>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <div class="xl:col-span-2 card rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-white">Daily Performance Trend</h3>
            </div>
            <div class="chart-container">
              <canvas id="dailyTrendChart"></canvas>
            </div>
          </div>
          <div class="space-y-6">
            <div class="card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-white mb-4">Engagement Benchmark</h3>
              <div class="chart-container-small">
                <canvas id="gaugeER"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Temporal Analytics</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Hourly Performance</h3>
            <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
          </div>
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Daily Performance</h3>
            <div class="chart-container"><canvas id="dailyChart"></canvas></div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Performance Heatmap</h3>
            <div class="chart-container"><canvas id="hourlyHeatmap"></canvas></div>
          </div>
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Weekend vs Weekday</h3>
            <div class="chart-container"><canvas id="weekendChart"></canvas></div>
          </div>
        </div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Brand Performance</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Top Brands by Engagement</h3>
            <div class="chart-container"><canvas id="brandChart"></canvas></div>
          </div>
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Brand Completion Rates</h3>
            <div class="chart-container"><canvas id="brandCompletionChart"></canvas></div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Performance Matrix</h3>
            <div class="chart-container"><canvas id="brandScatterChart"></canvas></div>
          </div>
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Brand Contribution</h3>
            <div class="chart-container"><canvas id="brandParetoChart"></canvas></div>
          </div>
        </div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Content Analysis</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Content Type Performance</h3>
            <div class="chart-container"><canvas id="contentChart"></canvas></div>
          </div>
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Content Distribution</h3>
            <div class="chart-container"><canvas id="contentStackedChart"></canvas></div>
          </div>
        </div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Performance Rankings</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card rounded-xl p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <h3 class="text-lg font-semibold text-white">Top Performers</h3>
            </div>
            <div class="overflow-x-auto"><table id="topTable"></table></div>
          </div>
          <div class="card rounded-xl p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
              <h3 class="text-lg font-semibold text-white">Improvement Areas</h3>
            </div>
            <div class="overflow-x-auto"><table id="worstTable"></table></div>
          </div>
        </div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Executive Report</h2>
        <div class="card rounded-xl p-6">
          <article id="executiveMd" class="prose prose-invert max-w-none"></article>
        </div>
      </section>

      <section class="section-card rounded-2xl p-8">
        <h2 class="section-title text-white mb-8">Advanced Analytics</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Engagement Distribution</h3>
            <div class="chart-container"><canvas id="engagementHistChart"></canvas></div>
          </div>
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Performance Benchmarks</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="text-center"><div class="chart-container-small"><canvas id="gaugeCR"></canvas></div><p class="text-white/60 text-sm mt-2">Completion Rate</p></div>
              <div class="text-center"><div class="chart-container-small"><canvas id="gaugeViral"></canvas></div><p class="text-white/60 text-sm mt-2">Viral Performance</p></div>
              <div class="text-center"><div class="chart-container-small"><canvas id="kpiRadar"></canvas></div><p class="text-white/60 text-sm mt-2">Overall Performance</p></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const colors = { primary: ['#0ea5e9','#38bdf8','#7dd3fc'], success: ['#22c55e','#4ade80','#86efac'], warning: ['#f59e0b','#fbbf24','#fcd34d'], danger: ['#ef4444','#f87171','#fca5a5'], neutral: ['#64748b','#94a3b8','#cbd5e1'] };
      let charts = {};

      // Tooltip definitions (metrics and charts)
      const tooltips = {
        // KPIs
        'Impressions': 'Total displays across posts.\nFormula: sum(impressions)',
        'Engagements': 'Total interactions (likes, comments, shares).\nFormula: sum(engagements)',
        'Views': 'Total video plays (≥1s).\nFormula: sum(video_views)',
        'Posts': 'Total posts analyzed.\nFormula: count(posts)',
        'Eng. Rate': 'Engagements ÷ Views × 100 (dataset average).\nFormula: (sum(engagements)/sum(views)) × 100',
        'Completion': 'Average % watched; retention indicator.\nFormula: mean(completion_rate) × 100',
        'View Rate': 'Views ÷ Impressions × 100.\nFormula: (sum(views)/sum(impressions)) × 100',
        'Avg Duration': 'Average video length (seconds).\nFormula: mean(duration)',
        'Avg Eng/Post': 'Average engagements per post.\nFormula: total_engagements ÷ total_posts',
        'Avg Views/Post': 'Average views per post.\nFormula: total_video_views ÷ total_posts',
        'Max Views/Post': 'Highest per-post views.\nFormula: max(video_views)',
        'Max Impr/Post': 'Highest per-post impressions.\nFormula: max(impressions)',
        'Brands': 'Distinct brands analyzed.\nFormula: count(unique brand names)',
        'Content Types': 'Distinct content types analyzed.\nFormula: count(unique content_type)',
        'Max Eng/Post': 'Highest engagements for a single post.\nFormula: max(engagements)',
        'Best Hour': 'Hour with highest average engagements.\nFormula: argmax(mean(engagements) by hour)',
        'Best Day': 'Weekday with highest average engagements.\nFormula: argmax(mean(engagements) by day)',
        'Worst Hour': 'Hour with lowest average engagements.\nFormula: argmin(mean(engagements) by hour)',
        'Worst Day': 'Weekday with lowest average engagements.\nFormula: argmin(mean(engagements) by day)',
        'Top Duration (ER)': 'Duration bucket with highest engagement rate.\nFormula: argmax(avg_engagement_rate) over duration_summary',
        'Top Duration (CR)': 'Duration bucket with highest completion rate.\nFormula: argmax(avg_completion_rate) over duration_summary',

        // Executive Summary
        'Engagement Rate': 'Audience interaction quality.\nFormula: (sum(engagements)/sum(views)) × 100',
        'Content Volume': 'Sample size for reliability.\nFormula: count(posts)',
        'Completion Rate': 'Average % watched; retention indicator.\nFormula: mean(completion_rate) × 100',
        'Viral Threshold': '95th percentile of views; “viral” cutoff.\nFormula: quantile(views, 0.95)',
        'Above High ER': 'Share of posts above ER benchmark.\nFormula: mean(ER_post > high_engagement_threshold) × 100',
        'Above High CR': 'Share of posts above CR benchmark.\nFormula: mean(CR_post > high_completion_threshold) × 100',

        // Charts
        'Daily Performance Trend': 'Avg engagements by day.\nFormula: mean(engagements) per day_of_week',
        'Hourly Performance': 'Avg engagements by hour.\nFormula: mean(engagements) per hour',
        'Daily Performance': 'Weekday engagement pattern.\nFormula: mean(engagements) per day_of_week',
        'Performance Heatmap': 'Hour×day engagement intensity.\nFormula: mean(engagements) per (day,hour)',
        'Weekend vs Weekday': 'Comparison of avg engagements.\nFormula: mean(engagements) for weekend vs weekday',
        'Top Brands by Engagement': 'Avg ER by brand (ranked).\nFormula: (avg_engagements/avg_impressions) × 100',
        'Brand Completion Rates': 'Avg completion by brand.\nFormula: mean(completion_rate) × 100',
        'Performance Matrix': 'ER vs CR per brand (top-right best).\nFormula: x=avg ER, y=avg CR',
        'Brand Contribution': 'Pareto of total engagements.\nFormula: total_engagements per brand + cumulative %',
        'Content Type Performance': 'Avg ER by content type.\nFormula: (avg_engagements/avg_impressions) × 100',
        'Content Distribution': 'Post volume by content type.\nFormula: count(posts) per type',
        'Engagement Distribution': 'Histogram of per-post engagements.\nFormula: bin counts over engagements',
        'Completion Rate': 'Gauge: average completion % (CR).\nFormula: mean(completion_rate) × 100',
        'Viral Performance': 'Avg views vs viral threshold.\nFormula: mean(views_per_post) / viral_threshold × 100',
        'Overall Performance': 'Radar of key metrics.\nFormula: normalized key metrics',
        'Engagement Benchmark': 'Dataset engagement benchmark (avg ER).\nFormula: (sum(engagements)/sum(views)) × 100',
        // Tables/sections
        'Top Performers': 'Top 10% posts by engagement rate.\nFormula: engagement_rate ≥ 90th percentile',
        'Improvement Areas': 'Bottom 10% posts by engagement rate.\nFormula: engagement_rate ≤ 10th percentile',
        'Executive Report': 'Markdown executive summary generated by the analytics agent.'
      };

      // Canvas id → help key
      const chartHelp = {
        dailyTrendChart: 'Daily Performance Trend',
        hourlyChart: 'Hourly Performance',
        dailyChart: 'Daily Performance',
        hourlyHeatmap: 'Performance Heatmap',
        weekendChart: 'Weekend vs Weekday',
        brandChart: 'Top Brands by Engagement',
        brandCompletionChart: 'Brand Completion Rates',
        brandScatterChart: 'Performance Matrix',
        brandParetoChart: 'Brand Contribution',
        contentChart: 'Content Type Performance',
        contentStackedChart: 'Content Distribution',
        engagementHistChart: 'Engagement Distribution',
        gaugeER: 'Engagement Benchmark',
        gaugeCR: 'Completion Rate',
        gaugeViral: 'Viral Performance',
        kpiRadar: 'Overall Performance'
      };

      // Tooltip element
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      document.body.appendChild(tooltip);

      function showTooltip(event, text){
        tooltip.textContent = text; tooltip.classList.add('show');
        const tooltipRect = tooltip.getBoundingClientRect();
        const margin = 8; let left = event.clientX + margin; let top = event.clientY + margin + 4;
        if (left + tooltipRect.width > window.innerWidth - 10) left = Math.max(10, window.innerWidth - tooltipRect.width - 10);
        if (top + tooltipRect.height > window.innerHeight - 10) top = Math.max(10, event.clientY - tooltipRect.height - margin);
        tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
      }
      function hideTooltip(){ tooltip.classList.remove('show'); }

      // Anchor tooltip near a specific element (consistent placement)
      function showTooltipAtElement(el, text){
        if (!el) return;
        tooltip.textContent = text; tooltip.classList.add('show');
        const rect = el.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        let left = rect.left + 8;
        let top = rect.bottom + 6;
        if (left < 10) left = 10;
        if (left + tooltipRect.width > window.innerWidth - 10) left = Math.max(10, window.innerWidth - tooltipRect.width - 10);
        if (top + tooltipRect.height > window.innerHeight - 10) top = Math.max(10, rect.top - tooltipRect.height - 6);
        tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
      }

      // Anchor tooltip near a canvas (chart) top-left
      function showTooltipAtCanvas(canvas, text){
        if (!canvas) return;
        tooltip.textContent = text; tooltip.classList.add('show');
        const rect = canvas.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        let left = rect.left + 8;
        let top = rect.top + 8;
        if (left < 10) left = 10;
        if (left + tooltipRect.width > window.innerWidth - 10) left = Math.max(10, window.innerWidth - tooltipRect.width - 10);
        tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
      }

      function addTooltips(){
        // KPI cards (anchor to label element)
        document.querySelectorAll('#kpis .card').forEach(function(card){
          const labelEl = card.querySelector('.text-xs'); if(!labelEl) return;
          const label = labelEl.textContent.trim(); const txt = tooltips[label]; if(!txt) return;
          card.style.cursor = 'help';
          card.addEventListener('mouseenter', function(){ showTooltipAtElement(labelEl, txt); });
          card.addEventListener('mouseleave', hideTooltip);
        });
        // Executive summary cards (keep as-is; already correct)
        document.querySelectorAll('#executiveSummary .card').forEach(function(card){
          const titleEl = card.querySelector('h3'); if(!titleEl) return;
          const title = titleEl.textContent.trim(); const txt = tooltips[title]; if(!txt) return;
          card.style.cursor = 'help';
          card.addEventListener('mouseenter', function(e){ showTooltip(e, txt); });
          card.addEventListener('mouseleave', hideTooltip);
        });
        // Chart cards (anchor to chart title or canvas)
        document.querySelectorAll('.chart-container canvas, .chart-container-small canvas').forEach(function(canvas){
          const card = canvas.closest('.card'); if(!card) return;
          const titleEl = card.querySelector('h3');
          const key = chartHelp[canvas.id] || (titleEl ? titleEl.textContent.trim() : '');
          const txt = tooltips[key]; if(!txt) return;
          if (titleEl) {
            titleEl.style.cursor = 'help';
            titleEl.addEventListener('mouseenter', function(){ showTooltipAtElement(titleEl, txt); });
            titleEl.addEventListener('mouseleave', hideTooltip);
          }
          canvas.style.cursor = 'help';
          canvas.addEventListener('mouseenter', function(){ showTooltipAtCanvas(canvas, txt); });
          canvas.addEventListener('mouseleave', hideTooltip);
        });
        // Table cards (anchor to section title)
        document.querySelectorAll('#topTable, #worstTable').forEach(function(tbl){
          const card = tbl.closest('.card'); if(!card) return;
          const titleEl = card.querySelector('h3'); if(!titleEl) return;
          const key = titleEl.textContent.trim(); const txt = tooltips[key]; if(!txt) return;
          card.style.cursor = 'help';
          card.addEventListener('mouseenter', function(){ showTooltipAtElement(titleEl, txt); });
          card.addEventListener('mouseleave', hideTooltip);
        });
        // Executive report (anchor to section title)
        var execCard = document.querySelector('#executiveMd');
        if (execCard) {
          execCard = execCard.closest('.card');
          const titleEl = execCard && execCard.closest('.section-card') ? execCard.closest('.section-card').querySelector('h2') : null;
          const txt = tooltips['Executive Report'];
          if (txt && titleEl && execCard) {
            execCard.style.cursor = 'help';
            execCard.addEventListener('mouseenter', function(){ showTooltipAtElement(titleEl, txt); });
            execCard.addEventListener('mouseleave', hideTooltip);
          }
        }
      }

      function addChartHelpText(){
        document.querySelectorAll('.chart-container canvas, .chart-container-small canvas').forEach(function(canvas){
          const card = canvas.closest('.card'); if(!card) return;
          const mappedKey = chartHelp[canvas.id];
          const titleEl = card.querySelector('h3.text-lg');
          const cardTitle = titleEl ? titleEl.textContent.trim() : '';
          const helpKey = mappedKey || cardTitle; const txt = tooltips[helpKey]; if(!txt) return;
          let anchorEl = titleEl;
          if (!anchorEl) return;
          if (card.querySelector('.chart-help[data-for="' + canvas.id + '"]')) return;
          const help = document.createElement('p'); help.className = 'chart-help text-white/60 text-xs'; help.textContent = txt; help.setAttribute('data-for', canvas.id);
          anchorEl.insertAdjacentElement('afterend', help);
        });
      }

      function bindChartCanvasTooltips(){ /* disabled for charts */ }
      function destroyChart(ref){ if(charts[ref]){ charts[ref].destroy(); delete charts[ref]; } }
      function createChart(ctx, config){ return new Chart(ctx, config); }
      function safe(v,d){ return (v===undefined||v===null)?d:v; }
      function formatNumber(n){ const v=+n||0; if(v>=1e9) return (v/1e9).toFixed(1)+'B'; if(v>=1e6) return (v/1e6).toFixed(1)+'M'; if(v>=1e3) return (v/1e3).toFixed(1)+'K'; return v.toLocaleString(); }
      function formatPercent(n){ const v=+n||0; return `${v.toFixed(1)}%`; }

      function drawExecutiveSummary(bundle){
        const container = document.getElementById('executiveSummary');
        const km = safe(bundle.dataset_overview?.key_metrics, {});
        const ds = safe(bundle.dataset_overview, {});
        const bench = safe(bundle.dataset_overview?.performance_benchmarks, {});
        const hourly = safe(bundle.temporal_analytics?.hourly_performance, []);
        const daily = safe(bundle.temporal_analytics?.daily_performance, []);

        const bestHour = hourly.length ? hourly.reduce((a,b)=> (a.avg_engagements||0) >= (b.avg_engagements||0) ? a : b).hour : null;
        const bestDay = daily.length ? daily.reduce((a,b)=> (a.avg_engagements||0) >= (b.avg_engagements||0) ? a : b).day_of_week : null;
        const totalPostsES = +ds.total_posts || 0;
        const avgViewsPerPostES = totalPostsES ? (+km.total_video_views || 0) / totalPostsES : 0;
        const avgEngPerPostES = totalPostsES ? (+km.total_engagements || 0) / totalPostsES : 0;
        const viewRateES = (+km.total_impressions || 0) ? ((+km.total_video_views || 0) / (+km.total_impressions || 1)) * 100 : 0;

        const insights = [
          { type:'positive', t:'Engagement Rate', v: formatPercent(km.average_engagement_rate||0), d:'Average engagement across all content' },
          { type:'neutral', t:'Content Volume', v: formatNumber(ds.total_posts||0), d:'Total posts analyzed' },
          { type:(+km.average_completion_rate||0) > 50 ? 'positive':'negative', t:'Completion Rate', v: formatPercent(km.average_completion_rate||0), d:'Average video completion rate' },
          { type:'neutral', t:'Viral Threshold', v: formatNumber(bench.viral_threshold), d:'95th percentile of views (viral cutoff)' },
          { type:'good', t:'Best Hour', v:(bestHour===null||bestHour===undefined)?'N/A':(bestHour+':00'), d:'Hour with highest avg engagements' },
          { type:'good', t:'Best Day', v: bestDay || 'N/A', d:'Weekday with highest avg engagements' },
          { type:'neutral', t:'View Rate', v: (viewRateES||0).toFixed(1) + '%', d:'Views ÷ Impressions' },
          { type:'neutral', t:'Avg Views/Post', v: formatNumber(avgViewsPerPostES), d:'Average views per post' },
          { type:'neutral', t:'Avg Eng/Post', v: formatNumber(avgEngPerPostES), d:'Average engagements per post' }
        ];

        container.innerHTML = insights.map(x=>`<div class="card rounded-xl p-6"><h3 class="text-lg font-semibold text-white mb-3">${x.t}</h3><div class="metric-primary text-white mb-2">${x.v}</div><p class="text-white/60 text-sm">${x.d}</p></div>`).join('');
      }

      function drawKPIs(bundle){
        const container = document.getElementById('kpis');
        const km = safe(bundle.dataset_overview?.key_metrics, {});
        const ds = safe(bundle.dataset_overview, {});
        const hourly = safe(bundle.temporal_analytics?.hourly_performance, []);
        const daily = safe(bundle.temporal_analytics?.daily_performance, []);
        const brandSummary = safe(bundle.brand_performance?.brand_summary, []);
        const contentSummary = safe(bundle.content_type_performance?.content_summary, []);
        const topPosts = safe(bundle.top_performers?.top_posts, []);

        const totalPosts = +ds.total_posts || 0;
        const avgEngPerPost = totalPosts ? (+km.total_engagements || 0) / totalPosts : 0;
        const avgViewsPerPost = totalPosts ? (+km.total_video_views || 0) / totalPosts : 0;
        const viewRate = (+km.total_impressions || 0) ? ((+km.total_video_views || 0) / (+km.total_impressions || 1)) * 100 : 0;
        const brandsCount = Array.isArray(brandSummary) ? brandSummary.length : 0;
        const contentTypesCount = Array.isArray(contentSummary) ? new Set(contentSummary.map(d=>d.content_type)).size : 0;
        const maxEngPost = Math.max(0, ...(topPosts||[]).map(p => +p.facebook_insights_engagements || 0));
        const bestHour = hourly.length ? hourly.reduce((a,b)=> (a.avg_engagements||0) >= (b.avg_engagements||0) ? a : b).hour : null;
        const worstHour = hourly.length ? hourly.reduce((a,b)=> (a.avg_engagements||Infinity) <= (b.avg_engagements||Infinity) ? a : b).hour : null;
        const bestDay = daily.length ? daily.reduce((a,b)=> (a.avg_engagements||0) >= (b.avg_engagements||0) ? a : b).day_of_week : null;
        const worstDay = daily.length ? daily.reduce((a,b)=> (a.avg_engagements||Infinity) <= (b.avg_engagements||Infinity) ? a : b).day_of_week : null;

        // From key_metrics if available
        const maxViewsPost = +km.max_views_post || 0;
        const maxImprPost = +km.max_impressions_post || 0;

        const kpis = [
          { label: 'Impressions', value: formatNumber(km.total_impressions), color: colors.primary[0] },
          { label: 'Engagements', value: formatNumber(km.total_engagements), color: colors.success[0] },
          { label: 'Views', value: formatNumber(km.total_video_views), color: colors.warning[0] },
          { label: 'Posts', value: formatNumber(ds.total_posts), color: colors.danger[0] },
          { label: 'Eng. Rate', value: formatPercent(km.average_engagement_rate), color: colors.success[1] },
          { label: 'Completion', value: formatPercent(km.average_completion_rate), color: colors.primary[1] },
          { label: 'Avg Eng/Post', value: formatNumber(avgEngPerPost), color: colors.neutral[0] },
          { label: 'Avg Views/Post', value: formatNumber(avgViewsPerPost), color: colors.neutral[1] },
          { label: 'View Rate', value: (viewRate||0).toFixed(1) + '%', color: colors.neutral[2] },
          { label: 'Brands', value: formatNumber(brandsCount), color: colors.primary[2] },
          { label: 'Content Types', value: formatNumber(contentTypesCount), color: colors.success[2] },
          { label: 'Max Eng/Post', value: formatNumber(maxEngPost), color: colors.warning[2] },
          { label: 'Max Views/Post', value: formatNumber(maxViewsPost), color: colors.neutral[0] },
          { label: 'Max Impr/Post', value: formatNumber(maxImprPost), color: colors.neutral[1] },
          { label: 'Best Hour', value: (bestHour===null||bestHour===undefined)?'N/A':(bestHour+':00'), color: colors.primary[0] },
          { label: 'Best Day', value: bestDay || 'N/A', color: colors.success[0] },
          { label: 'Worst Hour', value: (worstHour===null||worstHour===undefined)?'N/A':(worstHour+':00'), color: colors.warning[0] },
          { label: 'Worst Day', value: worstDay || 'N/A', color: colors.danger[0] }
        ];

        container.innerHTML = kpis.map(d=>`<div class=\"card rounded-xl p-4 text-center\"><div class=\"w-3 h-3 rounded-full mx-auto mb-3\" style=\"background: ${d.color}\"></div><div class=\"metric-secondary text-white mb-1\">${d.value}</div><div class=\"text-white/60 text-xs font-medium uppercase tracking-wide\">${d.label}</div></div>`).join('');
      }

      function drawDailyTrend(bundle){
        const data = safe(bundle.temporal_analytics?.daily_performance, []); if(!data.length) return;
        const ctx = document.getElementById('dailyTrendChart'); destroyChart('dailyTrend');
        charts.dailyTrend = createChart(ctx, { type:'line', data:{ labels:data.map(d=>d.day_of_week), datasets:[{ label:'Avg Engagements', data:data.map(d=>d.avg_engagements||0), borderColor: colors.primary[0], backgroundColor: colors.primary[0]+'20', borderWidth:3, fill:true, tension:0.4 }] } });
      }

      function drawHourly(bundle){
        const data = safe(bundle.temporal_analytics?.hourly_performance, []); if(!data.length) return;
        const ctx = document.getElementById('hourlyChart'); destroyChart('hourly');
        charts.hourly = createChart(ctx, { type:'line', data:{ labels:data.map(d=>d.hour), datasets:[{ label:'Avg Engagements', data:data.map(d=>d.avg_engagements||0), borderColor: colors.success[0], backgroundColor: colors.success[0]+'20', borderWidth:3, fill:true, tension:0.4 }] } });
      }

      function drawHourlyHeatmap(bundle){
        const grid = safe(bundle.temporal_analytics?.hour_by_day, []);
        const ctx = document.getElementById('hourlyHeatmap'); if(!ctx || !grid.length) return;
        destroyChart('hourlyHeatmap');
        const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        const maxV = Math.max(...grid.map(g => g.avg_engagements || 0), 1);
        const data = grid.map(g => ({ x: g.hour, y: days.indexOf(g.day_of_week), v: g.avg_engagements || 0 }));
        charts.hourlyHeatmap = new Chart(ctx, {
          type: 'matrix',
          data: {
            datasets: [{
              label: 'Avg Engagements',
              data: data,
              backgroundColor: function(c){
                const v = c.raw.v || 0;
                const intensity = Math.min(0.8, (v / maxV) * 0.8 + 0.2);
                return 'rgba(14,165,233,' + intensity + ')';
              },
              width: function(ctx){
                const chart = ctx.chart;
                return (chart.chartArea || {}).width / 24;
              },
              height: function(ctx){
                const chart = ctx.chart;
                return (chart.chartArea || {}).height / 7;
              },
              borderWidth: 1,
              borderColor: 'rgba(255,255,255,0.1)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { type: 'linear', min: 0, max: 23 },
              y: { type: 'category', labels: days }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      function drawWeekendWeekday(bundle){
        const data = safe(bundle.temporal_analytics?.daily_performance, []); if(!data.length) return;
        const weekend=['Saturday','Sunday']; let wkd=0,wkdN=0,wke=0,wkeN=0;
        data.forEach(d=>{ if(weekend.includes(d.day_of_week)){ wke += d.avg_engagements||0; wkeN++; } else { wkd += d.avg_engagements||0; wkdN++; } });
        const ctx = document.getElementById('weekendChart'); if(!ctx) return; destroyChart('weekend');
        charts.weekend = new Chart(ctx, { type:'doughnut', data:{ labels:['Weekday','Weekend'], datasets:[{ data:[wkdN?wkd/wkdN:0, wkeN?wke/wkeN:0], backgroundColor:[colors.primary[0]+'80', colors.success[0]+'80'], borderColor:[colors.primary[0], colors.success[0]], borderWidth:2 }] }, options:{ cutout:'60%' } });
      }

      function drawBrands(bundle){
        const data = safe(bundle.brand_performance?.brand_rankings?.top_by_engagement_rate, []); if(!data.length) return;
        const ctx = document.getElementById('brandChart'); if(!ctx) return; destroyChart('brand');
        charts.brand = new Chart(ctx, { type:'bar', data:{ labels:data.map(d=>d.brand), datasets:[{ label:'Engagement Rate (%)', data:data.map(d=>d.avg_engagement_rate||0), backgroundColor: colors.primary[0]+'80', borderColor: colors.primary[0], borderWidth:2, borderRadius:6 }] } });
      }

      function drawBrandCompletion(bundle){
        const summary = safe(bundle.brand_performance?.brand_summary, []); if(!summary.length) return;
        const top = [...summary].sort((a,b)=> (b.avg_completion_rate||0)-(a.avg_completion_rate||0)).slice(0,10);
        const ctx = document.getElementById('brandCompletionChart'); if(!ctx) return; destroyChart('brandCompletion');
        charts.brandCompletion = new Chart(ctx, { type:'bar', data:{ labels: top.map(d=> d.brand), datasets:[{ label:'Avg Completion Rate (%)', data: top.map(d=> (d.avg_completion_rate||0)), backgroundColor: colors.warning[0]+'80', borderColor: colors.warning[0], borderWidth:2, borderRadius:6 }] } });
      }

      function drawBrandPerformanceMatrix(bundle){
        const summary = safe(bundle.brand_performance?.brand_summary, []); if(!summary.length) return;
        const ctx = document.getElementById('brandScatterChart'); if(!ctx) return; destroyChart('brandScatter');
        charts.brandScatter = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Brand',
              data: summary.map(function(d){
                return { x: d.avg_engagement_rate || 0, y: (d.avg_completion_rate || 0), label: String(d.brand) };
              }),
              backgroundColor: colors.primary[0]
            }]
          },
          options: {
            parsing: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(c){
                    return String(c.raw.label) + ': ER ' + ((+c.raw.x).toFixed(2)) + '%, CR ' + ((+c.raw.y).toFixed(2)) + '%';
                  }
                }
              }
            },
            scales: {
              x: { title: { display: true, text: 'Avg Engagement Rate (%)' } },
              y: { title: { display: true, text: 'Avg Completion Rate (%)' } }
            }
          }
        });
      }

      function drawBrandContribution(bundle){
        const summary = safe(bundle.brand_performance?.brand_summary, []); if(!summary.length) return;
        const sorted = [...summary].sort((a,b)=> (b.total_engagements||0)-(a.total_engagements||0)).slice(0,20);
        const values = sorted.map(d=> d.total_engagements||0); const total = values.reduce((a,b)=>a+b,0)||1; const cum = values.map((v,i)=> (values.slice(0,i+1).reduce((a,b)=>a+b,0)/total)*100);
        const ctx = document.getElementById('brandParetoChart'); if(!ctx) return; destroyChart('brandPareto');
        charts.brandPareto = new Chart(ctx, {
          data: {
            labels: sorted.map(function(d){ return d.brand; }),
            datasets: [
              { type: 'bar', label: 'Engagements', data: values, backgroundColor: colors.primary[1] + '80', borderColor: colors.primary[1], borderWidth: 2, borderRadius: 6, yAxisID: 'y' },
              { type: 'line', label: 'Cumulative %', data: cum, borderColor: colors.danger[0], tension: 0.3, yAxisID: 'y1' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { position: 'left', title: { display: true, text: 'Engagements' } },
              y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Cumulative %' } }
            }
          }
        });
      }

      function drawContent(bundle){
        const data = safe(bundle.content_type_performance?.content_rankings?.highest_engagement_content, []); if(!data.length) return;
        const ctx = document.getElementById('contentChart'); if(!ctx) return; destroyChart('content');
        charts.content = new Chart(ctx, { type:'bar', data:{ labels:data.map(d=> d.content_type), datasets:[{ label:'Engagement Rate (%)', data:data.map(d=> d.avg_engagement_rate||0), backgroundColor: colors.success[0]+'80', borderColor: colors.success[0], borderWidth:2, borderRadius:6 }] } });
      }

      function drawContentDistribution(bundle){
        const data = safe(bundle.content_type_performance?.content_summary, []); if(!data.length) return;
        const grouped = {}; data.forEach(d=>{ grouped[d.content_type] = (grouped[d.content_type]||0) + (d.total_posts||0); });
        const labels = Object.keys(grouped).slice(0,15);
        const ctx = document.getElementById('contentStackedChart'); if(!ctx) return; destroyChart('contentStacked');
        charts.contentStacked = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Posts', data: labels.map(l=> grouped[l]||0), backgroundColor: colors.primary[2]+'80', borderColor: colors.primary[2], borderWidth:2, borderRadius:6 }] } });
      }

      function drawEngagementBenchmark(bundle){
        const km = safe(bundle.dataset_overview?.key_metrics, {});
        const val = +km.average_engagement_rate || 0;
        const ctx = document.getElementById('gaugeER'); if(!ctx) return; destroyChart('gaugeER');
        charts.gaugeER = new Chart(ctx, {
          type: 'doughnut',
          data: { datasets: [{ data: [Math.min(100, val), Math.max(0, 100 - val)], backgroundColor: [colors.success[0], '#ffffff22'], borderWidth: 0 }] },
          options: { cutout: '70%', plugins: { legend: { display: false }, title: { display: true, text: (val.toFixed(1) + '%') } } }
        });
      }

      function drawEngagementDistribution(bundle){
        const sample = safe(bundle.per_post_sample?.per_post_sample, []); if(!sample.length) return;
        const vals = sample.map(s=> +s.facebook_insights_engagements||0).filter(v=> Number.isFinite(v)); if(!vals.length) return;
        const bins = 20, max = Math.max(...vals), edges = Array.from({length: bins+1}, (_,i)=> (i/bins)*max);
        const counts = Array(bins).fill(0); vals.forEach(v=>{ const idx=Math.min(bins-1, Math.floor((v/max)*bins)); counts[idx]++; });
        const labels = counts.map((_,i)=> `${Math.round(edges[i])}-${Math.round(edges[i+1])}`);
        const ctx = document.getElementById('engagementHistChart'); if(!ctx) return; destroyChart('engHist');
        charts.engHist = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Posts', data: counts, backgroundColor: colors.neutral[2]+'80', borderColor: colors.neutral[2], borderWidth:2, borderRadius:6 }] } });
      }

      function drawPerformanceBenchmarks(bundle){
        const km = safe(bundle.dataset_overview?.key_metrics, {});
        const bench = safe(bundle.dataset_overview?.performance_benchmarks, {});
        const ds = safe(bundle.dataset_overview, {});
        // Completion gauge
        const ctxCR = document.getElementById('gaugeCR'); if(ctxCR){ destroyChart('gaugeCR'); const cr = +km.average_completion_rate||0; charts.gaugeCR = new Chart(ctxCR, { type:'doughnut', data:{ datasets:[{ data:[Math.min(100,cr), Math.max(0,100-cr)], backgroundColor:[colors.primary[0], '#ffffff22'], borderWidth:0 }] }, options:{ cutout:'70%', plugins:{ legend:{ display:false }, title:{ display:true, text:`${cr.toFixed(1)}%` } } } }); }
        // Viral gauge
        const ctxV = document.getElementById('gaugeViral'); if(ctxV){ destroyChart('gaugeViral'); const totalPosts = +ds.total_posts||0; const avgViews = totalPosts ? ((+km.total_video_views||0)/totalPosts) : 0; const thr = +bench.viral_threshold||1; const pct = Math.min(100, Math.max(0, (avgViews/thr)*100)); charts.gaugeViral = new Chart(ctxV, { type:'doughnut', data:{ datasets:[{ data:[pct, 100-pct], backgroundColor:[colors.warning[0], '#ffffff22'], borderWidth:0 }] }, options:{ cutout:'70%', plugins:{ legend:{ display:false }, title:{ display:true, text:`${pct.toFixed(1)}%` } } } }); }
        // KPI Radar
        const ctxR = document.getElementById('kpiRadar'); if(ctxR){ destroyChart('kpiRadar'); const dataR = [ Math.min(100, +km.average_engagement_rate||0), Math.min(100, +km.average_completion_rate||0), +km.total_video_views||0, +km.total_engagements||0, +km.total_impressions||0 ]; charts.kpiRadar = new Chart(ctxR, { type:'radar', data:{ labels:['Eng %','Comp %','Views','Engagements','Impressions'], datasets:[{ label:'KPI', data: dataR, borderColor: colors.primary[0], backgroundColor: colors.primary[0]+'33' }] } }); }
      }

      function drawDaily(bundle){
        const data = safe(bundle.temporal_analytics?.daily_performance, []); if(!data.length) return;
        const ctx = document.getElementById('dailyChart'); destroyChart('daily');
        charts.daily = createChart(ctx, { type:'bar', data:{ labels:data.map(d=>d.day_of_week), datasets:[{ label:'Avg Engagements', data:data.map(d=>d.avg_engagements||0), backgroundColor: colors.primary[0]+'80', borderColor: colors.primary[0], borderWidth:2, borderRadius:6 }] } });
      }

      function renderTopWorstTables(bundle){
        const top = safe(bundle.top_performers?.top_posts, []).slice(0,10);
        const worst = safe(bundle.worst_performers?.worst_posts, []).slice(0,10);
        const rowTop = r=> `<tr><td>${r.facebook_id||''}</td><td>${(+r.engagement_rate||0).toFixed(2)}%</td><td>${(+r.facebook_insights_video_views_average_completion||0).toFixed(2)}%</td></tr>`;
        const rowWorst = r=> `<tr><td>${r.facebook_id||''}</td><td>${(+r.engagement_rate||0).toFixed(2)}%</td><td>${(+r.facebook_insights_video_views_average_completion||0).toFixed(2)}%</td></tr>`;
        const topTbl = document.getElementById('topTable'); topTbl.innerHTML = top.length? `<thead><tr><th>Post</th><th>Eng %</th><th>Comp %</th></tr></thead><tbody>${top.map(rowTop).join('')}</tbody>` : '<em class="text-white/60">No data</em>';
        const worstTbl = document.getElementById('worstTable'); worstTbl.innerHTML = worst.length? `<thead><tr><th>Post</th><th>Eng %</th><th>Comp %</th></tr></thead><tbody>${worst.map(rowWorst).join('')}</tbody>` : '<em class="text-white/60">No data</em>';
      }

      function renderExecutive(bundle){
        const md = bundle.executive_report_md || '';
        var el = document.getElementById('executiveMd');
        if (!el) return;
        el.innerHTML = md ? marked.parse(md) : '<em class="text-white/60">No report found</em>';
      }

      function showLoading(){ document.getElementById('loadText').textContent = 'Loading'; document.getElementById('loadSpinner').classList.remove('hidden'); document.getElementById('status').innerHTML = '<div class="loading-spinner"></div> <span>Loading data...</span>'; }
      function hideLoading(){ document.getElementById('loadText').textContent = 'Load Data'; document.getElementById('loadSpinner').classList.add('hidden'); document.getElementById('status').innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full"></div> <span>Data loaded</span>'; }

      async function loadBundle(){
        showLoading();
        const ds = document.getElementById('datasetId').value.trim();
        const url = ds ? `./dashboard_bundle_${ds}.json` : `./dashboard_facebook_bundle_latest.json`;
        try { const res = await fetch(url); const bundle = await res.json();
          drawExecutiveSummary(bundle); drawKPIs(bundle); drawDailyTrend(bundle); drawHourly(bundle); drawDaily(bundle); drawEngagementBenchmark(bundle); drawHourlyHeatmap(bundle); drawWeekendWeekday(bundle); drawBrands(bundle); drawBrandCompletion(bundle); drawBrandPerformanceMatrix(bundle); drawBrandContribution(bundle); drawContent(bundle); drawContentDistribution(bundle); drawEngagementDistribution(bundle); drawPerformanceBenchmarks(bundle); renderTopWorstTables(bundle); renderExecutive(bundle); addTooltips(); bindChartCanvasTooltips(); addChartHelpText(); hideLoading();
        } catch(e){ document.getElementById('status').innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full"></div> <span>Load failed</span>'; console.error('Load error:', e); }
      }

      document.getElementById('loadBtn').addEventListener('click', loadBundle);
      window.addEventListener('DOMContentLoaded', loadBundle);
    </script>
  </body>
</html>


